<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üé® –ö–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä –§–æ—Ç–æ–∞–ª—å–±–æ–º–æ–≤</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .auth-container {
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            width: 100%;
            max-width: 400px;
            padding: 40px;
        }

        .auth-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .auth-header h1 {
            font-size: 28px;
            color: #333;
            margin-bottom: 10px;
        }

        .auth-header p {
            color: #999;
            font-size: 14px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            color: #555;
            font-weight: 500;
            font-size: 14px;
        }

        input, select, textarea {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s;
            font-family: inherit;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 10px rgba(102, 126, 234, 0.1);
        }

        button {
            width: 100%;
            padding: 12px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 10px;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.4);
        }

        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .toggle-form {
            text-align: center;
            margin-top: 20px;
            color: #999;
            font-size: 14px;
        }

        .toggle-form a {
            color: #667eea;
            cursor: pointer;
            text-decoration: underline;
        }

        .error {
            background: #fee;
            color: #c33;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 14px;
        }

        .success {
            background: #efe;
            color: #3c3;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 14px;
        }

        .hidden {
            display: none;
        }

        .app-container {
            background: white;
            min-height: 100vh;
            padding: 20px;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            font-size: 28px;
        }

        .user-info {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .user-info span {
            font-size: 14px;
        }

        .logout-btn {
            background: rgba(255,255,255,0.3);
            padding: 8px 16px;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s;
            border: none;
            color: white;
            width: auto;
        }

        .logout-btn:hover {
            background: rgba(255,255,255,0.5);
        }

        .menu {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin-bottom: 30px;
        }

        .menu-btn {
            background: #f5f5f5;
            border: 2px solid #e0e0e0;
            color: #333;
            padding: 12px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
            width: auto;
            margin: 0;
        }

        .menu-btn.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-color: transparent;
        }

        .menu-btn:hover {
            border-color: #667eea;
        }

        .section {
            display: none;
        }

        .section.active {
            display: block;
        }

        .album-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .album-card {
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .album-card:hover {
            border-color: #667eea;
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.2);
        }

        .album-card h3 {
            color: #333;
            margin-bottom: 10px;
        }

        .album-card .date {
            font-size: 12px;
            color: #999;
        }

        .form-box {
            background: #f9f9f9;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .form-box h2 {
            color: #333;
            margin-bottom: 20px;
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }

        textarea {
            grid-column: 1 / -1;
            resize: vertical;
            min-height: 100px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }

        .stat-card .number {
            font-size: 32px;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .stat-card .label {
            font-size: 14px;
            opacity: 0.9;
        }

        .photo-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .photo-item {
            position: relative;
            border-radius: 8px;
            overflow: hidden;
            background: #f0f0f0;
        }

        .photo-item img {
            width: 100%;
            height: 150px;
            object-fit: cover;
        }

        .photo-delete {
            position: absolute;
            top: 5px;
            right: 5px;
            background: rgba(255,0,0,0.7);
            color: white;
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: all 0.3s;
            padding: 0;
            margin: 0;
        }

        .photo-item:hover .photo-delete {
            opacity: 1;
        }

        .back-btn {
            padding: 10px 20px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin-bottom: 20px;
            width: auto;
        }
    </style>
</head>
<body>

<div id="auth-screen" class="auth-container">
    <div class="auth-header">
        <h1>üé® –§–æ—Ç–æ–∞–ª—å–±–æ–º—ã</h1>
        <p>–í–æ–π–¥–∏ –∏–ª–∏ —Å–æ–∑–¥–∞–π –∞–∫–∫–∞—É–Ω—Ç</p>
    </div>

    <div id="auth-error" class="error hidden"></div>
    <div id="auth-success" class="success hidden"></div>

    <!-- –õ–æ–≥–∏–Ω —Ñ–æ—Ä–º–∞ -->
    <div id="login-form">
        <div class="form-group">
            <label>–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</label>
            <input type="text" id="login-username" placeholder="—Ç–≤–æ—ë –∏–º—è">
        </div>
        <div class="form-group">
            <label>–ü–∞—Ä–æ–ª—å</label>
            <input type="password" id="login-password" placeholder="–ø–∞—Ä–æ–ª—å">
        </div>
        <button onclick="handleLogin()">–í–æ–π—Ç–∏</button>
        <div class="toggle-form">
            –ù–µ—Ç –∞–∫–∫–∞—É–Ω—Ç–∞? <a onclick="toggleForm()">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–π—Å—è</a>
        </div>
    </div>

    <!-- –†–µ–≥–∏—Å—Ç—Ä —Ñ–æ—Ä–º–∞ -->
    <div id="register-form" class="hidden">
        <div class="form-group">
            <label>–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</label>
            <input type="text" id="register-username" placeholder="–ø—Ä–∏–¥—É–º–∞–π –∏–º—è">
        </div>
        <div class="form-group">
            <label>Email</label>
            <input type="email" id="register-email" placeholder="—Ç–≤–æ–π email">
        </div>
        <div class="form-group">
            <label>–ü–∞—Ä–æ–ª—å</label>
            <input type="password" id="register-password" placeholder="–ø–∞—Ä–æ–ª—å (–º–∏–Ω 6 —Å–∏–º–≤–æ–ª–æ–≤)">
        </div>
        <div class="form-group">
            <label>–ü–æ–≤—Ç–æ—Ä–∏ –ø–∞—Ä–æ–ª—å</label>
            <input type="password" id="register-password2" placeholder="–ø–∞—Ä–æ–ª—å –µ—â—ë —Ä–∞–∑">
        </div>
        <button onclick="handleRegister()">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</button>
        <div class="toggle-form">
            –£–∂–µ –µ—Å—Ç—å –∞–∫–∫–∞—É–Ω—Ç? <a onclick="toggleForm()">–í–æ–π–¥–∏</a>
        </div>
    </div>
</div>

<!-- –ì–ª–∞–≤–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ -->
<div id="app-screen" class="app-container hidden">
    <div class="header">
        <h1>üé® –ö–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä –§–æ—Ç–æ–∞–ª—å–±–æ–º–æ–≤</h1>
        <div class="user-info">
            <span>–ü—Ä–∏–≤–µ—Ç, <strong id="current-user"></strong>!</span>
            <button class="logout-btn" onclick="handleLogout()">–í—ã–π—Ç–∏</button>
        </div>
    </div>

    <div class="menu">
        <button class="menu-btn active" onclick="switchSection('albums')">üìã –ê–ª—å–±–æ–º—ã</button>
        <button class="menu-btn" onclick="switchSection('create-album')">‚ûï –ù–æ–≤—ã–π –∞–ª—å–±–æ–º</button>
        <button class="menu-btn" onclick="switchSection('upload')">üì∏ –ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–æ—Ç–æ</button>
        <button class="menu-btn" onclick="switchSection('stats')">üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</button>
    </div>

    <!-- –ê–ª—å–±–æ–º—ã -->
    <div id="albums" class="section active">
        <h2>–ú–æ–∏ –ê–ª—å–±–æ–º—ã</h2>
        <div id="albums-grid" class="album-grid"></div>
    </div>

    <!-- –°–æ–∑–¥–∞–Ω–∏–µ –∞–ª—å–±–æ–º–∞ -->
    <div id="create-album" class="section">
        <div class="form-box">
            <h2>‚ûï –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π –∞–ª—å–±–æ–º</h2>
            <div class="form-row">
                <div>
                    <label>–ù–∞–∑–≤–∞–Ω–∏–µ</label>
                    <input type="text" id="album-title" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –û—Ç–ø—É—Å–∫ 2024">
                </div>
            </div>
            <div class="form-row">
                <div>
                    <label>–û–ø–∏—Å–∞–Ω–∏–µ</label>
                    <textarea id="album-description" placeholder="–ß—Ç–æ –≤ —ç—Ç–æ–º –∞–ª—å–±–æ–º–µ?"></textarea>
                </div>
            </div>
            <button onclick="createAlbum()">–°–æ–∑–¥–∞—Ç—å</button>
        </div>
    </div>

    <!-- –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–æ—Ç–æ -->
    <div id="upload" class="section">
        <div class="form-box">
            <h2>üì∏ –ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—é</h2>
            <div class="form-row">
                <div>
                    <label>–í—ã–±–µ—Ä–∏ –∞–ª—å–±–æ–º</label>
                    <select id="album-select" style="width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 8px;">
                        <option value="">-- –í—ã–±–µ—Ä–∏ –∞–ª—å–±–æ–º --</option>
                    </select>
                </div>
            </div>
            <div class="form-row">
                <input type="file" id="photo-file" accept="image/*">
            </div>
            <div class="form-row">
                <label>–û–ø–∏—Å–∞–Ω–∏–µ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</label>
                <textarea id="photo-description" placeholder="–ß—Ç–æ –Ω–∞ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏?"></textarea>
            </div>
            <button onclick="uploadPhoto()">–ó–∞–≥—Ä—É–∑–∏—Ç—å</button>
        </div>
    </div>

    <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
    <div id="stats" class="section">
        <h2>üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h2>
        <div class="stats-grid">
            <div class="stat-card">
                <div class="number" id="stat-albums">0</div>
                <div class="label">–ê–ª—å–±–æ–º–æ–≤</div>
            </div>
            <div class="stat-card">
                <div class="number" id="stat-photos">0</div>
                <div class="label">–§–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π</div>
            </div>
            <div class="stat-card">
                <div class="number" id="stat-size">0</div>
                <div class="label">–ú–µ–≥–∞–±–∞–π—Ç</div>
            </div>
        </div>
    </div>
</div>

<script>
    const API_BASE = '/api';

    // ===== –ê–£–¢–ï–ù–¢–ò–§–ò–ö–ê–¶–ò–Ø =====
    function toggleForm() {
        document.getElementById('login-form').classList.toggle('hidden');
        document.getElementById('register-form').classList.toggle('hidden');
        document.getElementById('auth-error').classList.add('hidden');
        document.getElementById('auth-success').classList.add('hidden');
    }

    async function handleRegister() {
        const username = document.getElementById('register-username').value;
        const email = document.getElementById('register-email').value;
        const password = document.getElementById('register-password').value;
        const password2 = document.getElementById('register-password2').value;

        if (!username || !email || !password || !password2) {
            showAuthError('–ó–∞–ø–æ–ª–Ω–∏ –≤—Å–µ –ø–æ–ª—è');
            return;
        }

        try {
            const response = await fetch(`${API_BASE}/auth/register/`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username, email, password, password2 })
            });

            const data = await response.json();

            if (!response.ok) {
                const errors = Object.values(data).flat().join(', ');
                showAuthError(errors);
                return;
            }

            localStorage.setItem('access_token', data.access);
            localStorage.setItem('refresh_token', data.refresh);
            localStorage.setItem('username', data.user.username);

            showAppScreen();
        } catch (error) {
            showAuthError('–û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏: ' + error.message);
        }
    }

    async function handleLogin() {
        const username = document.getElementById('login-username').value;
        const password = document.getElementById('login-password').value;

        if (!username || !password) {
            showAuthError('–ó–∞–ø–æ–ª–Ω–∏ –æ–±–∞ –ø–æ–ª—è');
            return;
        }

        try {
            const response = await fetch(`${API_BASE}/auth/login/`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username, password })
            });

            const data = await response.json();

            if (!response.ok) {
                showAuthError(data.error || '–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ –≤–≤–µ–¥–µ–Ω—ã –¥–∞–Ω–Ω—ã–µ');
                return;
            }

            localStorage.setItem('access_token', data.access);
            localStorage.setItem('refresh_token', data.refresh);
            localStorage.setItem('username', data.user.username);

            showAppScreen();
        } catch (error) {
            showAuthError('–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞: ' + error.message);
        }
    }

    function handleLogout() {
        localStorage.removeItem('access_token');
        localStorage.removeItem('refresh_token');
        localStorage.removeItem('username');
        showAuthScreen();
    }

    function showAuthError(message) {
        const el = document.getElementById('auth-error');
        el.textContent = message;
        el.classList.remove('hidden');
    }

    function showAuthScreen() {
        document.getElementById('auth-screen').classList.remove('hidden');
        document.getElementById('app-screen').classList.add('hidden');
        document.getElementById('login-form').classList.remove('hidden');
        document.getElementById('register-form').classList.add('hidden');
        document.getElementById('auth-error').classList.add('hidden');
        document.getElementById('login-username').value = '';
        document.getElementById('login-password').value = '';
    }

    function showAppScreen() {
        document.getElementById('auth-screen').classList.add('hidden');
        document.getElementById('app-screen').classList.remove('hidden');
        document.getElementById('current-user').textContent = localStorage.getItem('username');
        loadAlbums();
        loadStats();
        loadAlbumSelect();
    }

    // ===== API –ó–ê–ü–†–û–°–´ =====
    // –û–±–Ω–æ–≤–ª–µ–Ω–æ –≤—ã—à–µ –≤ CANVAS_EDIT_1

    // ===== –ê–õ–¨–ë–û–ú–´ =====
    async function loadAlbums() {
        try {
            const data = await apiCall('/albums/');
            const grid = document.getElementById('albums-grid');
            grid.innerHTML = '';

            const albums = data.results || data;
            
            if (!albums || albums.length === 0) {
                grid.innerHTML = '<p style="color: #999;">–£ —Ç–µ–±—è –µ—â—ë –Ω–µ—Ç –∞–ª—å–±–æ–º–æ–≤. –°–æ–∑–¥–∞–π –ø–µ—Ä–≤—ã–π!</p>';
                return;
            }

            albums.forEach(album => {
                const card = document.createElement('div');
                card.className = 'album-card';
                card.innerHTML = `
                    <h3>${album.title}</h3>
                    <p style="color: #666; font-size: 14px;">${album.description || '(–±–µ–∑ –æ–ø–∏—Å–∞–Ω–∏—è)'}</p>
                    <div class="date">–§–æ—Ç–æ: ${album.photo_count || 0}</div>
                    <div style="margin-top: 10px; display: flex; gap: 10px;">
                        <button onclick="viewAlbum(${album.id})" style="flex: 1; padding: 8px; background: #667eea; color: white; border: none; border-radius: 5px; cursor: pointer;">–ü—Ä–æ—Å–º–æ—Ç—Ä</button>
                        <button onclick="deleteAlbum(${album.id})" style="flex: 1; padding: 8px; background: #f93e3e; color: white; border: none; border-radius: 5px; cursor: pointer;">–£–¥–∞–ª–∏—Ç—å</button>
                    </div>
                `;
                grid.appendChild(card);
            });
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∞–ª—å–±–æ–º–æ–≤:', error);
        }
    }

    async function createAlbum() {
        const title = document.getElementById('album-title').value;
        const description = document.getElementById('album-description').value;

        if (!title) {
            alert('–í–≤–µ–¥–∏ –Ω–∞–∑–≤–∞–Ω–∏–µ –∞–ª—å–±–æ–º–∞');
            return;
        }

        try {
            await apiCall('/albums/', 'POST', { title, description });
            document.getElementById('album-title').value = '';
            document.getElementById('album-description').value = '';
            loadAlbums();
            loadAlbumSelect();
            alert('‚úÖ –ê–ª—å–±–æ–º —Å–æ–∑–¥–∞–Ω!');
        } catch (error) {
            alert('–û—à–∏–±–∫–∞: ' + error.message);
        }
    }

    async function deleteAlbum(albumId) {
        if (!confirm('–¢–æ—á–Ω–æ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç –∞–ª—å–±–æ–º –∏ –≤—Å–µ —Ñ–æ—Ç–æ –≤ –Ω—ë–º?')) return;

        try {
            await apiCall(`/albums/${albumId}/`, 'DELETE');
            loadAlbums();
            loadAlbumSelect();
            alert('‚úÖ –ê–ª—å–±–æ–º —É–¥–∞–ª–µ–Ω!');
        } catch (error) {
            alert('–û—à–∏–±–∫–∞: ' + error.message);
        }
    }

    async function apiCall(endpoint, method = 'GET', body = null) {
        const token = localStorage.getItem('access_token');
        const options = {
            method,
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            }
        };

        if (body) {
            options.body = JSON.stringify(body);
        }

        const response = await fetch(`${API_BASE}${endpoint}`, options);
        
        if (response.status === 401) {
            handleLogout();
            throw new Error('–ù–µ–∞–≤—Ç–æ—Ä–∏–∑–∏—Ä–æ–≤–∞–Ω');
        }

        if (response.status === 204) {
            return null;
        }

        const text = await response.text();
        if (!text) {
            return null;
        }

        try {
            return JSON.parse(text);
        } catch (e) {
            throw new Error('Invalid JSON: ' + text.substring(0, 100));
        }
    }

    async function apiFormData(endpoint, method = 'POST', formData) {
        const token = localStorage.getItem('access_token');
        const response = await fetch(`${API_BASE}${endpoint}`, {
            method,
            headers: {
                'Authorization': `Bearer ${token}`
            },
            body: formData
        });

        if (response.status === 401) {
            handleLogout();
            throw new Error('–ù–µ–∞–≤—Ç–æ—Ä–∏–∑–∏—Ä–æ–≤–∞–Ω');
        }

        if (response.status === 204) {
            return null;
        }

        const text = await response.text();
        if (!text) {
            return null;
        }

        return JSON.parse(text);
    }

    // ===== –ê–õ–¨–ë–û–ú–´ =====
    async function loadAlbums() {
        try {
            const data = await apiCall('/albums/');
            const grid = document.getElementById('albums-grid');
            grid.innerHTML = '';

            const albums = data.results || data;
            
            if (!albums || albums.length === 0) {
                grid.innerHTML = '<p style="color: #999;">–£ —Ç–µ–±—è –µ—â—ë –Ω–µ—Ç –∞–ª—å–±–æ–º–æ–≤. –°–æ–∑–¥–∞–π –ø–µ—Ä–≤—ã–π!</p>';
                return;
            }

            albums.forEach(album => {
                const card = document.createElement('div');
                card.className = 'album-card';
                card.innerHTML = `
                    <h3>${album.title}</h3>
                    <p style="color: #666; font-size: 14px;">${album.description || '(–±–µ–∑ –æ–ø–∏—Å–∞–Ω–∏—è)'}</p>
                    <div class="date">–§–æ—Ç–æ: ${album.photo_count || 0}</div>
                    <div style="margin-top: 10px; display: flex; gap: 10px;">
                        <button onclick="viewAlbum(${album.id})" style="flex: 1; padding: 8px; background: #667eea; color: white; border: none; border-radius: 5px; cursor: pointer;">–ü—Ä–æ—Å–º–æ—Ç—Ä</button>
                        <button onclick="deleteAlbum(${album.id})" style="flex: 1; padding: 8px; background: #f93e3e; color: white; border: none; border-radius: 5px; cursor: pointer;">–£–¥–∞–ª–∏—Ç—å</button>
                    </div>
                `;
                grid.appendChild(card);
            });
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∞–ª—å–±–æ–º–æ–≤:', error);
        }
    }

    async function createAlbum() {
        const title = document.getElementById('album-title').value;
        const description = document.getElementById('album-description').value;

        if (!title) {
            alert('–í–≤–µ–¥–∏ –Ω–∞–∑–≤–∞–Ω–∏–µ –∞–ª—å–±–æ–º–∞');
            return;
        }

        try {
            await apiCall('/albums/', 'POST', { title, description });
            document.getElementById('album-title').value = '';
            document.getElementById('album-description').value = '';
            loadAlbums();
            loadAlbumSelect();
            alert('‚úÖ –ê–ª—å–±–æ–º —Å–æ–∑–¥–∞–Ω!');
        } catch (error) {
            alert('–û—à–∏–±–∫–∞: ' + error.message);
        }
    }

    async function deleteAlbum(albumId) {
        if (!confirm('–¢–æ—á–Ω–æ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç –∞–ª—å–±–æ–º –∏ –≤—Å–µ —Ñ–æ—Ç–æ –≤ –Ω—ë–º?')) return;

        try {
            await apiCall(`/albums/${albumId}/`, 'DELETE');
            loadAlbums();
            loadAlbumSelect();
            alert('‚úÖ –ê–ª—å–±–æ–º —É–¥–∞–ª–µ–Ω!');
        } catch (error) {
            alert('–û—à–∏–±–∫–∞: ' + error.message);
        }
    }

    async function viewAlbum(albumId) {
        try {
            const data = await apiCall(`/photos/?album=${albumId}`);
            const grid = document.getElementById('albums-grid');
            grid.innerHTML = `<button class="back-btn" onclick="loadAlbums()">‚Üê –ù–∞–∑–∞–¥</button>`;

            const photos = data.results || data;
            
            if (!photos || photos.length === 0) {
                const msg = document.createElement('p');
                msg.textContent = '–í —ç—Ç–æ–º –∞–ª—å–±–æ–º–µ –Ω–µ—Ç —Ñ–æ—Ç–æ';
                msg.style.color = '#999';
                grid.appendChild(msg);
                return;
            }

            const photoGrid = document.createElement('div');
            photoGrid.className = 'photo-grid';
            
            photos.forEach(photo => {
                const item = document.createElement('div');
                item.className = 'photo-item';
                item.innerHTML = `
                    <img src="${photo.image}" alt="—Ñ–æ—Ç–æ" style="cursor: pointer;" onclick="window.open('${photo.image}', '_blank')">
                    <button class="photo-delete" onclick="deletePhoto(${photo.id})">üóëÔ∏è</button>
                `;
                photoGrid.appendChild(item);
            });
            
            grid.appendChild(photoGrid);
        } catch (error) {
            alert('–û—à–∏–±–∫–∞: ' + error.message);
        }
    }

    async function loadAlbumSelect() {
        try {
            const data = await apiCall('/albums/');
            const select = document.getElementById('album-select');
            select.innerHTML = '<option value="">-- –í—ã–±–µ—Ä–∏ –∞–ª—å–±–æ–º --</option>';

            const albums = data.results || data;
            if (albums) {
                albums.forEach(album => {
                    const option = document.createElement('option');
                    option.value = album.id;
                    option.textContent = album.title;
                    select.appendChild(option);
                });
            }
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∞–ª—å–±–æ–º–æ–≤:', error);
        }
    }

    async function uploadPhoto() {
        const albumId = document.getElementById('album-select').value;
        const photoFile = document.getElementById('photo-file').files[0];
        const title = photoFile ? photoFile.name.split('.')[0] : '–§–æ—Ç–æ';  // ‚Üê –î–û–ë–ê–í–ò–¢–¨
        const description = document.getElementById('photo-description').value;

        if (!albumId || !photoFile) {
            alert('–í—ã–±–µ—Ä–∏ –∞–ª—å–±–æ–º –∏ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—é');
            return;
        }

        const formData = new FormData();
        formData.append('album', albumId);
        formData.append('image', photoFile);
        formData.append('title', title);  // ‚Üê –î–û–ë–ê–í–ò–¢–¨
        if (description) formData.append('description', description);

        try {
            await apiFormData('/photos/', 'POST', formData);
            document.getElementById('photo-file').value = '';
            document.getElementById('photo-description').value = '';
            alert('‚úÖ –§–æ—Ç–æ –∑–∞–≥—Ä—É–∂–µ–Ω–æ!');
            loadAlbumSelect();
        } catch (error) {
            alert('–û—à–∏–±–∫–∞: ' + error.message);
        }
    }



    async function deletePhoto(photoId) {
        if (!confirm('–£–¥–∞–ª–∏—Ç—å —Ñ–æ—Ç–æ?')) return;

        try {
            await apiCall(`/photos/${photoId}/`, 'DELETE');
            loadAlbums();
            alert('‚úÖ –§–æ—Ç–æ —É–¥–∞–ª–µ–Ω–æ!');
        } catch (error) {
            alert('–û—à–∏–±–∫–∞: ' + error.message);
        }
    }

    // ===== –°–¢–ê–¢–ò–°–¢–ò–ö–ê =====
    async function loadStats() {
        try {
            const data = await apiCall('/albums/user_albums_stats/');
            document.getElementById('stat-albums').textContent = data.total_albums || 0;
            document.getElementById('stat-photos').textContent = data.total_photos || 0;
            document.getElementById('stat-size').textContent = (data.total_size_mb || 0).toFixed(1);
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏:', error);
        }
    }

    // ===== UI =====
    function switchSection(sectionId) {
        document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
        document.querySelectorAll('.menu-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(sectionId).classList.add('active');
        event.target.classList.add('active');

        if (sectionId === 'albums') loadAlbums();
        if (sectionId === 'stats') loadStats();
    }

    // ===== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø =====
    window.addEventListener('load', () => {
        const token = localStorage.getItem('access_token');
        if (token) {
            showAppScreen();
        } else {
            showAuthScreen();
        }
    });
</script>

</body>
</html>
